version: '3.8'

services:
  # 1. Database (MongoDB)
  mongo:
    image: mongo:latest
    container_name: waf-mongo
    restart: always
    volumes:
      - mongo-data:/data/db

  # 2. Central Policy & Logging Service (Renamed to waf-policy)
  waf-policy:
    build:
      context: .
      dockerfile: Dockerfile
    command: python policy_service.py
    container_name: waf-policy
    ports:
      - "5000:5000"
    environment:
      - FLASK_APP=policy_service.py
      - ADMIN_USER=admin
      - ADMIN_PASS=admin
      - MONGO_URI=mongodb://waf-mongo:27017/
      # OAuth & Secrets
      - OAUTH_CLIENT_ID=
      - OAUTH_CLIENT_SECRET=
      - FLASK_SECRET=change_me_to_something_random
    depends_on:
      - mongo
    restart: always

  # 3. Input Filter Service
  waf-input:
    build:
      context: .
      dockerfile: Dockerfile
    command: python input_filter.py
    container_name: waf-input
    ports:
      - "8080:8080"
    environment:
      # Updated connection URL to point to waf-policy
      - LOGGER_URL=http://waf-policy:5000
      - NEXT_HOP_URL=http://waf-output:8081
    depends_on:
      - waf-policy
      - waf-output
    restart: always

  # 4. Output Filter Service
  waf-output:
    build:
      context: .
      dockerfile: Dockerfile
    command: python output_filter.py
    container_name: waf-output
    expose:
      - "8081"
    environment:
      # Updated connection URL to point to waf-policy
      - LOGGER_URL=http://waf-policy:5000
      - TARGET_URL=http://open-webui:8080
    depends_on:
      - waf-policy
      - open-webui
    restart: always

  # 5. Target Application
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    volumes:
      - open-webui-data:/app/backend/data
    restart: always

volumes:
  open-webui-data:
  mongo-data: