version: '3.8'

services:
  # 1. Database (MongoDB) with Auth
  mongo:
    image: mongo:latest
    container_name: waf-mongo
    restart: always
    environment:
      # Inject credentials from .env
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASS:-adminpassword}
    volumes:
      - mongo-data:/data/db

  # 2. Central Policy & Logging Service
  waf-policy:
    build:
      context: .
      dockerfile: Dockerfile
    command: python policy_service.py
    container_name: waf-policy
    ports:
      - "5000:5000"
    environment:
      - FLASK_APP=policy_service.py
      # Admin Credentials for UI
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASS=${ADMIN_PASS:-admin}
      # API Token for REST Access
      - API_TOKEN=${API_TOKEN}
      # Mongo Connection string constructed from variables
      - MONGO_URI=mongodb://${MONGO_USER:-admin}:${MONGO_PASS:-adminpassword}@waf-mongo:27017/
      # Secrets
      - FLASK_SECRET=${FLASK_SECRET:-supersecretkey}
      - OAUTH_CLIENT_ID=${OAUTH_CLIENT_ID}
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET}
    depends_on:
      - mongo
    restart: always

  # 3. Input Filter Service
  waf-input:
    build:
      context: .
      dockerfile: Dockerfile
    command: python input_filter.py
    container_name: waf-input
    ports:
      - "8080:8080"
    environment:
      - LOGGER_URL=http://waf-policy:5000
      - NEXT_HOP_URL=http://waf-output:8081
    depends_on:
      - waf-policy
      - waf-output
    restart: always

  # 4. Output Filter Service
  waf-output:
    build:
      context: .
      dockerfile: Dockerfile
    command: python output_filter.py
    container_name: waf-output
    expose:
      - "8081"
    environment:
      - LOGGER_URL=http://waf-policy:5000
      - TARGET_URL=http://open-webui:8080
    depends_on:
      - waf-policy
      - open-webui
    restart: always

  # 5. Target Application
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    volumes:
      - open-webui-data:/app/backend/data
    restart: always

volumes:
  open-webui-data:
  mongo-data: