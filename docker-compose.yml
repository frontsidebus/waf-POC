version: '3.8'

services:
  # 1. Central Policy & Logging Service (The Brain)
  waf-logger:
    build:
      context: .
      dockerfile: Dockerfile
    command: python logger_service.py
    container_name: waf-logger
    ports:
      - "5000:5000" # Admin UI & API
    environment:
      - FLASK_APP=logger_service.py
      - ADMIN_USER=admin
      - ADMIN_PASS=admin
    volumes:
      - ./waf_data:/app/waf_data
    restart: always

  # 2. Input Filter Service (The Entry Point)
  waf-input:
    build:
      context: .
      dockerfile: Dockerfile
    command: python input_filter.py
    container_name: waf-input
    ports:
      - "8080:8080" # Public Access Port
    environment:
      - LOGGER_URL=http://waf-logger:5000
      - NEXT_HOP_URL=http://waf-output:8081
    depends_on:
      - waf-logger
      - waf-output
    restart: always

  # 3. Output Filter Service (The Exit Guard)
  waf-output:
    build:
      context: .
      dockerfile: Dockerfile
    command: python output_filter.py
    container_name: waf-output
    expose:
      - "8081" # Internal only, accessed by waf-input
    environment:
      - LOGGER_URL=http://waf-logger:5000
      - TARGET_URL=http://open-webui:8080
    depends_on:
      - waf-logger
      - open-webui
    restart: always

  # 4. Target Application
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    volumes:
      - open-webui-data:/app/backend/data
    restart: always

volumes:
  open-webui-data: